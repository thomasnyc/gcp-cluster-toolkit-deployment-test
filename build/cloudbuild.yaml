steps:
  steps:
  - name: 'gcr.io/cloud-builders/docker'
    script: |
      docker build --network=cloudbuild --build-arg=ref=${_GHPC_VERSION} -t us-central1-docker.pkg.dev/$PROJECT_ID/clustertoolkit-docker-repo/gcluster-image:${_GHPC_VERSION} .
    automapSubstitutions: true

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 
           'us-central1-docker.pkg.dev/$PROJECT_ID/clustertoolkit-docker-repo/gcluster-image:${_GHPC_VERSION}']

  - name: 'us-central1-docker.pkg.dev/thomashk-mig/clustertoolkit-docker-repo/gcluster-image:1.64.0'
    id: 'Deploy Slurm cluster '
    entrypoint: 'gcluster'
    args:
      # THe 'deploy' command for creating a new cluster 
      - 'deploy'
      - '-d'
      - 'deploymentset/a3mega-slurm-deployment-thomashk.yaml'
      - '-w'
      - 'deploymentset/a3mega-lustre-slurm-blueprint.yaml'
      - '--auto-approve'